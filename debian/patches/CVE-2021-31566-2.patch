commit e2ad1a2c3064fa9eba6274b3641c4c1beed25c0b
Author: Martin Matuska <martin@matuska.org>
Date:   Sun Aug 22 03:53:28 2021 +0200

    Never follow symlinks when setting file flags on Linux
    
    When opening a file descriptor to set file flags on linux, ensure
    no symbolic links are followed. This fixes the case when an archive
    contains a directory entry followed by a symlink entry with the same
    path. The fixup code would modify file flags of the symlink target.

Index: libarchive-3.1.2/libarchive/archive_write_disk_posix.c
===================================================================
--- libarchive-3.1.2.orig/libarchive/archive_write_disk_posix.c	2022-02-20 14:31:04.419994483 +0100
+++ libarchive-3.1.2/libarchive/archive_write_disk_posix.c	2022-02-20 14:31:04.415994484 +0100
@@ -3448,7 +3448,8 @@
 
 	/* If we weren't given an fd, open it ourselves. */
 	if (myfd < 0) {
-		myfd = open(name, O_RDONLY | O_NONBLOCK | O_BINARY | O_CLOEXEC);
+		myfd = open(name, O_RDONLY | O_NONBLOCK | O_BINARY |
+		    O_CLOEXEC | O_NOFOLLOW);
 		__archive_ensure_cloexec_flag(myfd);
 	}
 	if (myfd < 0)
